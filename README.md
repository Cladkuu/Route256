# Route256

Сервера:
- Grpc-сервер работает на порту 8081
- HTTP-сервер работает на порту 8085
- Swagger UI работает на порту 8082
Swagger UI доступен по ссылке: http://localhost:8082/swagger/

Ручка для потоковой передачи данных: GetAllOrdersStream

При запросах в БД работает контекст. Время таймаута контекста установлено в internal/config/appConfig.go, константа ContextCancellationTimeout
Добавлен файл config.env, в котором указаны переменные окружения. В Git загружен пример данного файла под названием: config.env.example
В docker-compose.yaml указаны настройки для postgreSQL и pgBouncer
В Makefile добавлена команда: make up, - которая запускает сервисы из docker-compose.yaml
В папке internal/pkg/db создается инстанс БД. Также в данной папке производится создание, commit и rollback транзакций


Статусная модель заказа:
- NEW
- IN_PACKAGING
- IN_DELIVERY
- RECEIVED
- CANCELLED

Переходы в статусной модели заказа:
- NEW --> IN_PACKAGING, CANCELLED
- IN_PACKAGING --> IN_DELIVERY, CANCELLED
- IN_DELIVERY --> RECEIVED, CANCELLED
- RECEIVED - терминальный статус
- CANCELLED - терминальный статус

Архитектура папок:
 - internal/config - конфигурация приложения
 - internal/pkg - описание объекта приложения
 - internal/service - описание моделей, сервисов, хранилищ приложения

Use cases:
1. Отправить любой запрос без заголовка user-id и получить в ответе ошибку, что не передан данный заголовок

2. Ручка GetAllorders
Выводит список всех заказов. При старте приложения создается 3 заказа
Пример: /getAllorders

3. Ручка CreateOrder
Если вызвать команду:
   - если цена будет меньше 0, то будет ошибка
   - если валюта не соответствует списку валют из internal/app/storage/currencyStorage/currencyStorage.go, то будет ошибка
   - если не передан orderCode, то приложение само его создаст
   - если цена >0 и валюта соответствующая, то ручка создаст заказ
4. Команда /getOrderById
Если вызвать команду:
    - если id заказа НЕ существует, то будет ошибка
    - если id заказа существует, то в ответе вернется инфа по заказу
5. Команда /changeStatus
Если вызвать команду:
   - если id заказа НЕ существует, то будет ошибка
   - если в переданный статус нельзя перевести заказ, то будет ошибка
   К примеру, заказ в статусе NEW, пытаем его перевести в RECEIVED
   - если заказ существует и его можно перевести в переданный статус, то вернется success
     К примеру, заказ в статусе NEW, пытаем его перевести в IN_PACKAGING

6. Команда /resetOrderPrice
Если вызвать команду:
    - если id заказа НЕ существует, то будет ошибка
    - если id заказа  существует, то в ответе вернется success
7. Команда /cancelOrder
Если вызвать команду:
    - если id заказа НЕ существует, то будет ошибка
    - если заказ в терминальном статусе, то вернется ошибка, что заказ нельзя перевести в данный статус ((заказ должен быть в статусе CANCELLED || RECEIVED))
    - если id заказа  существует и его можно отменить, то в ответе вернется success
8. Отмена контекста
    - Если во время обращения к кешу отменится контекст, то вернется ошибка и изменяемые данные не будут сохранены
Можно в вызываемой функции кеша установить таймаут, который будет больше чем таймаут

Тестирование:
unit тесты написаны ко всем репозиториям, тесты расположены в папке - internal/app/storage
Интеграционные тесты написаны для ручек - internal/app/handlers/order
Для создания консистентного состояния данных в БД для каждого теста создан файл, который позволяет чистить таблицы и применять к ним необходимые скрипты в рамках одного теста - internal/pkg/suite/db.go
- TruncateTables - чистит нужные таблицы
- ImportFixtures - выполняет нужные скрипты
